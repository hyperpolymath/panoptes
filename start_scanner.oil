#!/usr/bin/env osh
# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 Jonathan D. A. Jewell <hyperpolymath>

# Panoptes Launcher Script
# Oil Shell for strict error handling and modern shell features

# Exit on error, undefined variables, and pipe failures
set -o errexit
set -o nounset
set -o pipefail

# Configuration
const APP_DIR = ${HOME:-/var/home/core}/panoptes
const LOG_DIR = $APP_DIR/logs
const LOG_FILE = $LOG_DIR/panoptes.log
const PID_FILE = $LOG_DIR/panoptes.pid
const CONTAINER_NAME = "panoptes-llm"

# Colors for output
const RED = '\033[0;31m'
const GREEN = '\033[0;32m'
const YELLOW = '\033[1;33m'
const NC = '\033[0m'  # No Color

proc log_info {
    echo -e "${GREEN}[INFO]${NC} $@"
}

proc log_warn {
    echo -e "${YELLOW}[WARN]${NC} $@"
}

proc log_error {
    echo -e "${RED}[ERROR]${NC} $@" >&2
}

proc check_dependencies {
    log_info "Checking dependencies..."

    if ! command -v podman > /dev/null 2>&1 {
        log_error "Podman is not installed"
        exit 1
    }

    if ! command -v just > /dev/null 2>&1 {
        log_error "Just command runner is not installed"
        exit 1
    }

    if ! test -f $APP_DIR/target/release/panoptes {
        log_warn "Binary not found, building..."
        cd $APP_DIR
        just build-release
    }

    log_info "All dependencies satisfied"
}

proc ensure_engine_running {
    log_info "Checking AI Engine status..."

    if ! podman ps --format "{{.Names}}" | grep -q $CONTAINER_NAME {
        log_info "Starting AI Engine..."
        cd $APP_DIR
        just start-engine
    } else {
        log_info "AI Engine already running"
    }
}

proc start_scanner {
    log_info "Starting Panoptes Scanner..."

    # Create log directory
    mkdir -p $LOG_DIR

    # Check if already running
    if test -f $PID_FILE {
        const old_pid = $(cat $PID_FILE)
        if ps -p $old_pid > /dev/null 2>&1 {
            log_warn "Scanner already running (PID: $old_pid)"
            exit 0
        } else {
            log_info "Removing stale PID file"
            rm -f $PID_FILE
        }
    }

    # Start scanner in background
    cd $APP_DIR
    nohup ./target/release/panoptes --config config.ncl >> $LOG_FILE 2>&1 &
    const pid = $!
    echo $pid > $PID_FILE

    log_info "Panoptes started (PID: $pid)"
    log_info "Logs: $LOG_FILE"
}

proc stop_scanner {
    log_info "Stopping Panoptes Scanner..."

    if test -f $PID_FILE {
        const pid = $(cat $PID_FILE)
        if ps -p $pid > /dev/null 2>&1 {
            kill $pid
            rm -f $PID_FILE
            log_info "Scanner stopped"
        } else {
            log_warn "Process not running, removing PID file"
            rm -f $PID_FILE
        }
    } else {
        log_warn "PID file not found, scanner may not be running"
    }
}

proc show_status {
    echo ""
    echo "=== Panoptes Status ==="
    echo ""

    # Scanner status
    if test -f $PID_FILE {
        const pid = $(cat $PID_FILE)
        if ps -p $pid > /dev/null 2>&1 {
            echo "Scanner: RUNNING (PID: $pid)"
        } else {
            echo "Scanner: STOPPED (stale PID file)"
        }
    } else {
        echo "Scanner: STOPPED"
    }

    # Engine status
    if podman ps --format "{{.Names}}" | grep -q $CONTAINER_NAME {
        echo "AI Engine: RUNNING"
    } else {
        echo "AI Engine: STOPPED"
    }

    # Recent log entries
    if test -f $LOG_FILE {
        echo ""
        echo "Recent logs:"
        tail -5 $LOG_FILE
    }
}

proc show_help {
    echo "Panoptes Launcher"
    echo ""
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  start   - Start the scanner daemon"
    echo "  stop    - Stop the scanner daemon"
    echo "  restart - Restart the scanner"
    echo "  status  - Show scanner and engine status"
    echo "  logs    - Follow the log file"
    echo "  help    - Show this help message"
    echo ""
    echo "Without arguments, starts the scanner."
}

# Main entry point
proc main {
    const command = ${1:-start}

    case $command {
        start {
            check_dependencies
            ensure_engine_running
            start_scanner
        }
        stop {
            stop_scanner
        }
        restart {
            stop_scanner
            sleep 2
            check_dependencies
            ensure_engine_running
            start_scanner
        }
        status {
            show_status
        }
        logs {
            if test -f $LOG_FILE {
                tail -f $LOG_FILE
            } else {
                log_error "Log file not found: $LOG_FILE"
                exit 1
            }
        }
        help | --help | -h {
            show_help
        }
        * {
            log_error "Unknown command: $command"
            show_help
            exit 1
        }
    }
}

main @ARGV
